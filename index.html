<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!-- <link rel="icon" href="<%= BASE_URL %>favicon.ico" /> -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="/icons/style.css" rel="stylesheet" />
    <title>Beardify</title>
  </head>
  <body>
    <noscript>
      <strong>
        We're sorry but Beardify doesn't work properly without JavaScript enabled. Please enable it to continue.
      </strong>
    </noscript>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
    <script>
      const ls = localStorage["beardify"];

      window.onSpotifyWebPlaybackSDKReady = () => {
        if (ls) {
          const player = new Spotify.Player({
            name: "Beardify3",
            getOAuthToken: (cb) => cb(JSON.parse(localStorage.getItem("beardify")).auth.auth.accessToken),
            volume: 0.5,
          });

          player.connect();
          player.on("authentication_error", () => window.dispatchEvent(new CustomEvent("noAccess")));

          // Update current player state
          setInterval(() => {
            player?.getCurrentState().then((state) => {
              window.dispatchEvent(
                new CustomEvent("playerStateChanged", {
                  detail: {
                    duration: state.duration,
                    position: state.position,
                    paused: state.paused,
                    repeatMode: state.repeat_mode,
                    shuffle: state.shuffle,
                    trackWindow: state.track_window,
                  },
                })
              );
            });
          }, 500);

          player.addListener("player_state_changed", (event) => {
            window.dispatchEvent(new CustomEvent("refreshToken"));
          });

          player.addListener("ready", ({ device_id }) => {
            window.dispatchEvent(
              new CustomEvent("initdevice", {
                detail: { thisDevice: device_id },
              })
            );
          });
        } else {
          window.dispatchEvent(new CustomEvent("noAccess"));
        }
      };
    </script>
  </body>
</html>
