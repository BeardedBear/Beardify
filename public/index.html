<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <link rel="icon" href="<%= BASE_URL %>favicon.ico" />
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <title>Beardify</title>
  </head>
  <body>
    <noscript>
      <strong>
        We're sorry but Beardify doesn't work properly without JavaScript enabled. Please enable it to continue.
      </strong>
    </noscript>
    <div id="app"></div>
    <script>
      const ls = localStorage["beardify"];

      window.onSpotifyWebPlaybackSDKReady = () => {
        if (ls) {
          const player = new Spotify.Player({
            name: "Beardify3",
            getOAuthToken: cb => cb(JSON.parse(localStorage.getItem("beardify")).auth.auth.accessToken),
            volume: 0.5
          });
          player.connect();

          player.on("authentication_error", () => window.dispatchEvent(new CustomEvent("noAccess")));

          window.setInterval(() => {
            player.getCurrentState().then(state => {
              if (state) {
                if (state.paused === false) {
                  window.dispatchEvent(
                    new CustomEvent("playerStateChanged", {
                      detail: { duration: state.duration, position: state.position, trackWindow: state.track_window }
                    })
                  );
                }
              }
            });
          }, 250);

          player.addListener("player_state_changed", event => {
            console.log(event);
            console.log("event.track_window", event.track_window);
            window.dispatchEvent(
              new CustomEvent("playerStateChanged", {
                detail: { duration: event.duration, position: event.position, trackWindow: event.track_window }
              })
            );
          });

          player.addListener("ready", ({ device_id }) => {
            window.dispatchEvent(
              new CustomEvent("initdevice", {
                detail: { thisDevice: device_id }
              })
            );
          });
        } else {
          window.dispatchEvent(new CustomEvent("noAccess"));
        }
      };
    </script>
  </body>
</html>
